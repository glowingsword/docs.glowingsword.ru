# Управление Fan Mode на серверах Supermicro

Считается, что на новых серверах Supermicro система охлаждения по умолчанию работает в оптимальном режиме.

На самом деле это справедливо лишь при работе сервера в эталлоном(с точки зрения его разработчиков) режиме работы, который нередко отличается от режима работы, в котором предполагается эксплуатировать сервер. 

На практике, нередко есть необходимость изменить режим их работы.

## Зоны охлаждения серверов Supermicro


На серверах Supermicro все вентиляторы разделены на две функциональные группы:

* Зона 0 – вентиляторы на CPU и в корпусе, помечаются как FAN1, где вместо 1 какой-то порядковый номер(1, 2 и т.п.).
* Зона 1 – вентиляторы периферии, помечаются как FANC, где вместо C – символ английского алфавита(A, B, C etc.).

## Режимы работы вентиляторов Supermicro

Всего есть 5 режимов работы вентиляторов:

| Режим работы     | Поведение вентиляторов зоны "Зона 1" | Поведение вентиляторов зоны "Зона 1" | Примечание |
| ---------------- | -------------------------------------| -------------------------------------| ---------- |
| PUE2/PUE Optimal | Аналогично Optimal(см. выше)          | Аналогично Optimal(см. выше)             | Мы **не используем** этот режим. Режим похожий на Optimal, от последнего отличается тем, что отдаёт предпочтение низкому энергопотреблению в ущерб производительности.   |
| Optimal          | **Базовая** скорость вращения — **30%**. При нагреве CPU повышается до **100%**. | Фиксированная скорость вращения — 30% | Мы **не используем** этот режим. Если на сервере хорошо нагружена I/O подсистема, а режим выставлен в Optimal – не удивляйтесь частым вылетам дисков(HDD и SSD очень  не любят перегрев), а также сбоям RAID-контроллеров, с последующей необходимостью их замены. |
| Standard         | **Базовая** скорость вращения — **50%**. При нагреве, в зависимости от температуры CPU, повышается до **100%**. | Базовая скорость вращения — **50%**. При нагреве, в зависимости от температуры PCH, повышается до **100%**. | Мы **не используем** этот режим. |
| Heavy IO         | **Базовая** скорость вращения — **50%**. При нагреве, в зависимости от температуры CPU, повышается до **100%**. | **Фиксированная** скорость вращения — **75%**            | Мы **используем** этот режим для бэкапов и всех остальных серверов, кроме microcloud-ов. |                         
| Full             | **Фиксированная** скорость вращения — **100%** | Фиксированная скорость вращения — **100%** | Мы **используем** этот режим для **microcloud-ов** и **бэкапов**. Режим, нацеленный на повышенную производительность. Больше энергии расходуется на охлаждение, но реже выходят из строя не любящие перегрев компоненты. |

На платформах X10DRU-+, при включенном "smart cooling mode" и режиме работы охлаждения PUE2 система автоматически переходит в режим PUE3, ещё боле агрессивно занижающий производительность, также этот режим характерен быстрым нагревом CPU(из-за недостаточного охлаждения) и возникающим из-за этого троттлингом. Подходит только для очень слабо нагруженных серверов.

На серверах Microcloud обычно доступны какие-то 4 режима из перечисленных выше. Обычно PUE2/PUE Optimal добавляют вместо режима Optimal, или вместо Standard.


## Изменение режима работы вентиляторов на платформе Supermicro

На платформах Supermicro X9/X10/X11 режим работы Fan Mode изменяется из web-интерфейса IPMI, или с помощью ipmitool.

### Смотрим и изменяемм режим работы Fan Mode в WEB-интерфейсе IPMI

1. Открываем web интерфейс IPMI и переходим в раздел Configuration > Fan mode.
2. Выбираем нужный нам режим, кликнув по нужному нам переключателю(Radiobutton).
3. Сохраняем изменение, нажав на кнопку Save.



### Смотрим и изменяем режим работы Fan Mode с помощью ipmitool

#### Смотрим текущий режим работы

!!! info "Внимание!"
    Если подключаемся к IPMI сервера не него самого, а удалённо, не забываем про нужны для подлкючения параметры, вроде: "-I lanplus -U <user name> -P <password> -H <hostname or IP>".

Считатываем режим работы вентиляторов командой

```bash
ipmitool raw 0x30 0x45 0x00
```

сравниваем результат с 

|Значение | Режим работы |
| ------- | ------------ |
| 00      | Standard     |
| 01      | Full         |
| 02      | Optimal      |
| 03      | PUE (Power Use Efficiency) |
| 04      | Heavy IO     |

#### Устаналиваем нужный нам режим работы вентиляторов

Делаем это одной из следующих команд:

Standard

```bash
ipmitool raw 0x30 0x45 0x1 0x0
```

Full

```bash
ipmitool raw 0x30 0x45 0x1 0x1
```

Optimal

```bash
ipmitool raw 0x30 0x45 0x1 0x2
```

Heavy IO

```bash
ipmitool raw 0x30 0x45 0x1 0x4
```


## Индивидуальное изменение настроек скорости работы вентиляторов

### Изменяем скорость работы вентиляторов

Перед изменением настроек пороговых значений необходимо сменить режим работы на Full, иначе ваши настройки будут переопределены BMC.

Текущие настройки для зоны "Зона 0" смотрим так:

```bash
ipmitool raw 0x30 0x70 0x66 0x00 0x00
```
для зоны "Зона 1":

```bash
ipmitool raw 0x30 0x70 0x66 0x00 0x00
```

!!! warning "Внимание"
    Данные команды были собраны с тематических сайтов и форумов, и лично не проверялись. Используйте их только если хорошо понимаете, что делаете.

Для следующих команд нам необходимо указать аргумент, указывающий скорость вращения:


Для зоны "Зона 0"

```bash
ipmitool 0x30 0x70 0x66 0x01 0x0 0x32
```

Для зоны "Зона 1"

```bash
ipmitool 0x30 0x70 0x66 0x01 0x1 0x32
```

Где  вместо **0x32** указываем число в диапазоне от 0x00 до 0x64 в шестнадцатеричной системе счисления, где 0x32 — 50%-я скорость вращения, а 0x64 — 100%-я.

### Изменение пороговых значений(thresholds)

## Список использованных при составлении данного руководства материалов

https://internet-lab.ru/supermicro_fan_speed
https://forum.ixbt.com/topic.cgi?id=66:8822-7
https://www.supermicro.com/support/faqs/faq.cfm?faq=18025
https://www.supermicro.com/support/faqs/faq.cfm?faq=18009
https://www.supermicro.com/support/faqs/faq.cfm?faq=23547
https://www.supermicro.com/support/faqs/faq.cfm?faq=17307
https://www.supermicro.com/support/faqs/faq.cfm?faq=19697
https://www.supermicro.com/support/faqs/faq.cfm?faq=19876
https://www.supermicro.com/manuals/other/IPMI_Users_Guide.pdf
https://www.informaticar.net/supermicro-motherboard-loud-fans/
https://github.com/khorton/nas_fan_control/blob/master/PID_fan_control.pl
https://forums.unraid.net/topic/99107-another-supermicro-fan-control-thread/
https://serverfault.com/questions/662526/fan-speeds-on-supermicro-system-via-ipmi
https://www.truenas.com/community/threads/thermal-and-accoustical-design-validation.28364/
https://www.reddit.com/r/freenas/comments/8fhqez/getting_those_supermicro_x9_motherboard_fans/
https://forums.servethehome.com/index.php?resources/supermicro-x9-x10-x11-fan-speed-control.20/
https://github.com/shoalex/SuperMicro/blob/master/SuperMicro/bin/Debug/SMCIPMITool/ReleaseNotes.txt
https://support.siliconmechanics.com/portal/en/kb/articles/changing-fan-speeds-for-x9-x10-series-boards
https://composter.com.ua/content/ipmi-na-konchikakh-palcev-upravlenie-servernym-parkom-so-smartfona-dlya-prodvinutykh
